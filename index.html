<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucille's Premium Catering - CRM Dashboard</title>
    <link rel="icon" href="img/lucilles-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress development warnings for single-file deployment
        if (typeof window !== 'undefined') {
            const originalWarn = console.warn;
            const originalError = console.error;
            console.warn = function(...args) {
                const message = args[0] || '';
                if (message.includes('tailwindcss.com should not be used in production') ||
                    message.includes('Be sure to precompile your scripts for production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
            console.error = function(...args) {
                const message = args[0] || '';
                if (message.includes('Be sure to precompile your scripts for production')) {
                    return;
                }
                originalError.apply(console, args);
            };
        }
    </script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.0/babel.min.js"></script>
    <style>
        .gradient-bg {
            background: #03752d;
        }
        .gradient-text {
            background: linear-gradient(135deg, #15803d 0%, #ca8a04 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-button {
            background: linear-gradient(135deg, #15803d 0%, #ca8a04 100%);
        }
        .gradient-button:hover {
            background: linear-gradient(135deg, #166534 0%, #a16207 100%);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
            color: #d97706;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // API Configuration - Replace with your actual Apps Script URL
        const API_CONFIG = {
            appsScriptUrl: 'https://script.google.com/macros/s/AKfycby4JP2aEBLqzgJUdYMmivRxrHwTCeWvtK7dxFDt-xXxs5hPcaWP0SwbrTqyeTpvfVZIPA/exec' // Replace this with the URL from Step 1
        };

        // No sample data - connecting to real Google Sheets

        const { useState, useEffect } = React;

        // Icon components using inline SVG (no external dependencies)
        const Icons = {
            Calendar: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('rect', { x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }),
               React.createElement('line', { x1: 16, y1: 2, x2: 16, y2: 6 }),
               React.createElement('line', { x1: 8, y1: 2, x2: 8, y2: 6 }),
               React.createElement('line', { x1: 3, y1: 10, x2: 21, y2: 10 })),
            
            Users: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2' }),
               React.createElement('circle', { cx: 9, cy: 7, r: 4 }),
               React.createElement('path', { d: 'M22 21v-2a4 4 0 0 0-3-3.87' }),
               React.createElement('path', { d: 'M16 3.13a4 4 0 0 1 0 7.75' })),
            
            TrendingUp: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('polyline', { points: '22,7 13.5,15.5 8.5,10.5 2,17' }),
               React.createElement('polyline', { points: '16,7 22,7 22,13' })),
            
            DollarSign: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('line', { x1: 12, y1: 1, x2: 12, y2: 23 }),
               React.createElement('path', { d: 'M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6' })),
            
            Bell: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9' }),
               React.createElement('path', { d: 'M13.73 21a2 2 0 0 1-3.46 0' })),
            
            Search: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('circle', { cx: 11, cy: 11, r: 8 }),
               React.createElement('path', { d: 'M21 21l-4.35-4.35' })),
            
            Filter: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('polygon', { points: '22,3 2,3 10,12.46 10,19 14,21 14,12.46' })),
            
            Mail: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z' }),
               React.createElement('polyline', { points: '22,6 12,13 2,6' })),
            
            Phone: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z' })),
            
            Gift: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('polyline', { points: '20,12 20,22 4,22 4,12' }),
               React.createElement('rect', { x: 2, y: 7, width: 20, height: 5 }),
               React.createElement('line', { x1: 12, y1: 22, x2: 12, y2: 7 }),
               React.createElement('path', { d: 'M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z' }),
               React.createElement('path', { d: 'M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z' })),
            
            Heart: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z' })),
            
            Briefcase: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('rect', { x: 2, y: 7, width: 20, height: 14, rx: 2, ry: 2 }),
               React.createElement('path', { d: 'M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16' })),
            
            Award: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('circle', { cx: 12, cy: 8, r: 7 }),
               React.createElement('polyline', { points: '8.21,13.89 7,23 12,20 17,23 15.79,13.88' })),
            
            Baby: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M9 12h6l-3-9-3 9z' }),
               React.createElement('path', { d: 'M6 20a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12a2 2 0 0 1 2 2 2 2 0 0 1-2 2H6z' })),
            
            GraduationCap: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M22 10v6M2 10l10-5 10 5-10 5z' }),
               React.createElement('path', { d: 'M6 12v5c3 3 9 3 12 0v-5' })),
            
            Star: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('polygon', { points: '12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26' })),
            
            AlertCircle: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
               React.createElement('line', { x1: 12, y1: 8, x2: 12, y2: 12 }),
               React.createElement('line', { x1: 12, y1: 16, x2: 12.01, y2: 16 })),
            
            CheckCircle: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }),
               React.createElement('polyline', { points: '22,4 12,14.01 9,11.01' })),
            
            XCircle: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
               React.createElement('line', { x1: 15, y1: 9, x2: 9, y2: 15 }),
               React.createElement('line', { x1: 9, y1: 9, x2: 15, y2: 15 })),
            
            Clock: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
               React.createElement('polyline', { points: '12,6 12,12 16,14' })),
            
            ChevronDown: ({ size = 16 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('polyline', { points: '6,9 12,15 18,9' })),
            
            Menu: ({ size = 24 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('line', { x1: 3, y1: 6, x2: 21, y2: 6 }),
               React.createElement('line', { x1: 3, y1: 12, x2: 21, y2: 12 }),
               React.createElement('line', { x1: 3, y1: 18, x2: 21, y2: 18 })),
            
            X: ({ size = 24 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('line', { x1: 18, y1: 6, x2: 6, y2: 18 }),
               React.createElement('line', { x1: 6, y1: 6, x2: 18, y2: 18 })),
            
            RefreshCw: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('polyline', { points: '23,4 23,10 17,10' }),
               React.createElement('polyline', { points: '1,20 1,14 7,14' }),
               React.createElement('path', { d: 'M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15' })),
            
            CalendarIcon: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('rect', { x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }),
               React.createElement('line', { x1: 16, y1: 2, x2: 16, y2: 6 }),
               React.createElement('line', { x1: 8, y1: 2, x2: 8, y2: 6 }),
               React.createElement('line', { x1: 3, y1: 10, x2: 21, y2: 10 })),
            
            ExternalLink: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6' }),
               React.createElement('polyline', { points: '15,3 21,3 21,9' }),
               React.createElement('line', { x1: 10, y1: 14, x2: 21, y2: 3 })),
            
            FileText: ({ size = 20 }) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2
            }, React.createElement('path', { d: 'M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8Z' }),
               React.createElement('polyline', { points: '14,2 14,8 20,8' }),
               React.createElement('line', { x1: 16, y1: 13, x2: 8, y2: 13 }),
               React.createElement('line', { x1: 16, y1: 17, x2: 8, y2: 17 }),
               React.createElement('polyline', { points: '10,9 9,9 8,9' }))
        };

        // Utility functions
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP'
            }).format(amount);
        };

        const formatDate = (dateString) => {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        const getEventIcon = (eventType) => {
            switch (eventType) {
                case 'Wedding': return <Icons.Heart />;
                case 'Birthday Party': return <Icons.Gift />;
                case 'Corporate Event': return <Icons.Briefcase />;
                case 'Anniversary': return <Icons.Star />;
                case 'Baptism/Christening': return <Icons.Baby />;
                case 'Graduation': return <Icons.GraduationCap />;
                default: return <Icons.CalendarIcon />;
            }
        };

        const getStatusColor = (status) => {
            switch (status) {
                case 'Closed(Won)':
                case 'Closed':
                    return 'bg-green-100 text-green-800 border-green-200';
                case 'Pending':
                case 'Pending Follow-up':
                    return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                case 'Lost':
                    return 'bg-red-100 text-red-800 border-red-200';
                default:
                    return 'bg-blue-100 text-blue-800 border-blue-200';
            }
        };

        const getStatusIcon = (status) => {
            switch (status) {
                case 'Closed(Won)':
                case 'Closed':
                    return <Icons.CheckCircle />;
                case 'Pending':
                case 'Pending Follow-up':
                    return <Icons.Clock />;
                case 'Lost':
                    return <Icons.XCircle />;
                default:
                    return <Icons.Clock />;
            }
        };

        // Data fetching functions
        const fetchLeads = async () => {
            try {
                if (API_CONFIG.appsScriptUrl.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') || 
                    API_CONFIG.appsScriptUrl === 'YOUR_APPS_SCRIPT_URL_HERE') {
                    throw new Error('Please configure your Google Apps Script URL');
                }
                const response = await fetch(`${API_CONFIG.appsScriptUrl}?action=getLeads`);
                if (!response.ok) throw new Error('Failed to fetch leads');
                const responseData = await response.json();
                
                // Handle different response formats from Google Apps Script
                let data;
                if (Array.isArray(responseData)) {
                    // Direct array response
                    data = responseData;
                } else if (responseData && typeof responseData === 'object') {
                    // Object wrapper - try to extract the data
                    data = responseData.data || responseData.leads || responseData.result || [];
                    if (!Array.isArray(data)) {
                        console.warn('Could not extract array from response:', responseData);
                        // Try to get the first property that is an array
                        const keys = Object.keys(responseData);
                        for (const key of keys) {
                            if (Array.isArray(responseData[key])) {
                                data = responseData[key];
                                break;
                            }
                        }
                        if (!Array.isArray(data)) {
                            data = [];
                        }
                    }
                } else {
                    console.error('Unexpected response format:', typeof responseData, responseData);
                    data = [];
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching leads:', error);
                throw error;
            }
        };

        const fetchDeals = async () => {
            try {
                if (API_CONFIG.appsScriptUrl.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') || 
                    API_CONFIG.appsScriptUrl === 'YOUR_APPS_SCRIPT_URL_HERE') {
                    throw new Error('Please configure your Google Apps Script URL');
                }
                const response = await fetch(`${API_CONFIG.appsScriptUrl}?action=getDeals`);
                if (!response.ok) throw new Error('Failed to fetch deals');
                const responseData = await response.json();
                
                // Handle different response formats from Google Apps Script
                let data;
                if (Array.isArray(responseData)) {
                    // Direct array response
                    data = responseData;
                } else if (responseData && typeof responseData === 'object') {
                    // Object wrapper - try to extract the data
                    data = responseData.data || responseData.deals || responseData.result || [];
                    if (!Array.isArray(data)) {
                        console.warn('Could not extract array from response:', responseData);
                        // Try to get the first property that is an array
                        const keys = Object.keys(responseData);
                        for (const key of keys) {
                            if (Array.isArray(responseData[key])) {
                                data = responseData[key];
                                break;
                            }
                        }
                        if (!Array.isArray(data)) {
                            data = [];
                        }
                    }
                } else {
                    console.error('Unexpected response format:', typeof responseData, responseData);
                    data = [];
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching deals:', error);
                throw error;
            }
        };

        const fetchData = async () => {
            const [leads, deals] = await Promise.all([fetchLeads(), fetchDeals()]);
            return { leads, deals };
        };

        // Main App Component
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [leads, setLeads] = useState([]);
            const [deals, setDeals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [dealFilter, setDealFilter] = useState('All Deals');
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [refreshing, setRefreshing] = useState(false);

            // Load data on component mount
            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    const data = await fetchData();
                    setLeads(data.leads);
                    setDeals(data.deals);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRefresh = async () => {
                setRefreshing(true);
                try {
                    await loadData();
                } catch (err) {
                    // Error handled in loadData
                } finally {
                    setRefreshing(false);
                }
            };

            // Calculate statistics with safety checks
            const stats = (() => {
                // Get latest deals only (most recent status for each reference number)
                const latestDeals = Array.isArray(deals) ? deals.reduce((acc, deal) => {
                    if (!deal || !deal.refNumber) return acc;
                    
                    const existing = acc[deal.refNumber];
                    if (!existing) {
                        acc[deal.refNumber] = deal;
                    } else {
                        // Compare timestamps to keep the most recent
                        try {
                            const existingTime = new Date(existing.timestamp || 0);
                            const currentTime = new Date(deal.timestamp || 0);
                            if (currentTime > existingTime) {
                                acc[deal.refNumber] = deal;
                            }
                        } catch (e) {
                            // If timestamp comparison fails, keep the first one
                        }
                    }
                    return acc;
                }, {}) : {};
                
                const latestDealsArray = Object.values(latestDeals);
                
                return {
                    totalLeads: Array.isArray(leads) ? leads.length : 0,
                    untrackedLeads: Array.isArray(leads) && latestDealsArray.length > 0 ? 
                        leads.filter(lead => {
                            if (!lead || !lead.refNumber) return false;
                            // Check if this lead has a corresponding deal (is tracked)
                            return !latestDealsArray.some(deal => deal && deal.refNumber === lead.refNumber);
                        }).length : (Array.isArray(leads) ? leads.length : 0),
                    closedDeals: latestDealsArray.filter(deal => deal && deal.status === 'Closed(Won)').length,
                    pendingDeals: latestDealsArray.filter(deal => deal && deal.status === 'Pending').length,
                    lostDeals: latestDealsArray.filter(deal => deal && deal.status === 'Lost').length,
                    totalRevenue: latestDealsArray.filter(deal => deal && deal.status === 'Closed(Won)')
                        .reduce((sum, deal) => sum + (parseFloat(deal.bookingAmount) || 0), 0),
                    totalCommission: latestDealsArray.filter(deal => deal && deal.status === 'Closed(Won)')
                        .reduce((sum, deal) => sum + (parseFloat(deal.commission) || 0), 0),
                    conversionRate: latestDealsArray.length > 0 ? 
                        (latestDealsArray.filter(deal => deal && deal.status === 'Closed(Won)').length / latestDealsArray.length * 100).toFixed(1) : 0
                };
            })();

            // Filter functions with safety checks
            const filteredLeads = (() => {
                // Get latest deals for tracking status check
                const latestDeals = Array.isArray(deals) ? deals.reduce((acc, deal) => {
                    if (!deal || !deal.refNumber) return acc;
                    
                    const existing = acc[deal.refNumber];
                    if (!existing) {
                        acc[deal.refNumber] = deal;
                    } else {
                        // Compare timestamps to keep the most recent
                        try {
                            const existingTime = new Date(existing.timestamp || 0);
                            const currentTime = new Date(deal.timestamp || 0);
                            if (currentTime > existingTime) {
                                acc[deal.refNumber] = deal;
                            }
                        } catch (e) {
                            // If timestamp comparison fails, keep the first one
                        }
                    }
                    return acc;
                }, {}) : {};
                
                const latestDealsArray = Object.values(latestDeals);
                
                return Array.isArray(leads) ? leads
                    .filter(lead => 
                        lead && (
                            (lead.clientName && lead.clientName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (lead.email && lead.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (lead.refNumber && lead.refNumber.toLowerCase().includes(searchTerm.toLowerCase()))
                        )
                    )
                    .map(lead => {
                        // Add tracking status to each lead
                        const isTracked = lead.refNumber && latestDealsArray.some(deal => 
                            deal && deal.refNumber === lead.refNumber
                        );
                        return {
                            ...lead,
                            isTracked: isTracked
                        };
                    })
                    .sort((a, b) => {
                        // Sort by timestamp (newest first)
                        try {
                            const timeA = new Date(a.timestamp || 0);
                            const timeB = new Date(b.timestamp || 0);
                            return timeB - timeA; // Newest first
                        } catch (e) {
                            return 0;
                        }
                    }) : [];
            })();

            const filteredDeals = (() => {
                // Get latest deals only (most recent status for each reference number)
                const latestDeals = Array.isArray(deals) ? deals.reduce((acc, deal) => {
                    if (!deal || !deal.refNumber) return acc;
                    
                    const existing = acc[deal.refNumber];
                    if (!existing) {
                        acc[deal.refNumber] = deal;
                    } else {
                        // Compare timestamps to keep the most recent
                        try {
                            const existingTime = new Date(existing.timestamp || 0);
                            const currentTime = new Date(deal.timestamp || 0);
                            if (currentTime > existingTime) {
                                acc[deal.refNumber] = deal;
                            }
                        } catch (e) {
                            // If timestamp comparison fails, keep the first one
                        }
                    }
                    return acc;
                }, {}) : {};
                
                const latestDealsArray = Object.values(latestDeals);
                
                return dealFilter === 'All Deals' 
                    ? latestDealsArray 
                    : latestDealsArray.filter(deal => deal && deal.status === dealFilter);
            })();

            const birthdayLeads = Array.isArray(leads) ? leads.filter(lead => {
                if (!lead || !lead.dateOfBirth) return false;
                try {
                    const birthDate = new Date(lead.dateOfBirth);
                    return birthDate.getMonth() === selectedMonth;
                } catch (e) {
                    return false;
                }
            }) : [];

            const upcomingEvents = Array.isArray(leads) && Array.isArray(deals) ? (() => {
                // Get latest deals only (most recent status for each reference number)
                const latestDeals = deals.reduce((acc, deal) => {
                    if (!deal || !deal.refNumber) return acc;
                    
                    const existing = acc[deal.refNumber];
                    if (!existing) {
                        acc[deal.refNumber] = deal;
                    } else {
                        // Compare timestamps to keep the most recent
                        try {
                            const existingTime = new Date(existing.timestamp || 0);
                            const currentTime = new Date(deal.timestamp || 0);
                            if (currentTime > existingTime) {
                                acc[deal.refNumber] = deal;
                            }
                        } catch (e) {
                            // If timestamp comparison fails, keep the first one
                        }
                    }
                    return acc;
                }, {});
                
                return leads.filter(lead => {
                    if (!lead || !lead.eventDate || !lead.refNumber) return false;
                    
                    // Get the latest deal status for this reference number
                    const latestDeal = latestDeals[lead.refNumber];
                    
                    // Check if the latest deal status is closed (won)
                    const hasClosedDeal = latestDeal && latestDeal.status === 'Closed(Won)';
                    
                    if (!hasClosedDeal) return false; // Only include leads with closed deals
                    
                    try {
                        const eventDate = new Date(lead.eventDate);
                        const today = new Date();
                        const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
                        return eventDate >= today && eventDate <= thirtyDaysFromNow;
                    } catch (e) {
                        return false;
                    }
                }).sort((a, b) => {
                    try {
                        return new Date(a.eventDate) - new Date(b.eventDate);
                    } catch (e) {
                        return 0;
                    }
                });
            })() : [];

            const getDaysUntilEvent = (eventDate) => {
                const today = new Date();
                const event = new Date(eventDate);
                const diffTime = event - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return { text: "Today", color: "bg-red-100 text-red-800" };
                if (diffDays === 1) return { text: "Tomorrow", color: "bg-red-100 text-red-800" };
                if (diffDays <= 7) return { text: `${diffDays} days`, color: "bg-red-100 text-red-800" };
                if (diffDays <= 14) return { text: `${diffDays} days`, color: "bg-yellow-100 text-yellow-800" };
                return { text: `${diffDays} days`, color: "bg-blue-100 text-blue-800" };
            };

            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            // Tab components
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: <Icons.TrendingUp /> },
                { id: 'leads', name: 'Leads', icon: <Icons.Users /> },
                { id: 'deals', name: 'Deals', icon: <Icons.DollarSign /> },
                { id: 'birthdays', name: 'Birthdays', icon: <Icons.Gift /> },
                { id: 'events', name: 'Events', icon: <Icons.Calendar /> }
            ];

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="loading-spinner mx-auto mb-4">
                                <Icons.RefreshCw />
                            </div>
                            <p className="text-yellow-600">Loading data from Google Sheets...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <Icons.AlertCircle />
                            <h2 className="text-xl font-semibold text-gray-800 mb-2">Connection Error</h2>
                            <p className="text-gray-600 mb-4">{error}</p>
                            <button
                                onClick={handleRefresh}
                                className="gradient-button text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-300"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-white shadow-lg sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                {/* Logo */}
                                <div className="flex items-center space-x-4">
                                    <div className="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-lg">
                                        <img src="img/lucilles-logo.png" alt="Lucille's Logo" className="w-10 h-10 object-contain" />
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold gradient-text">Lucille's Premium Catering</h1>
                                        <p className="text-sm text-gray-600">CRM Dashboard</p>
                                    </div>
                                </div>

                                {/* Desktop Navigation */}
                                <nav className="hidden md:flex space-x-8">
                                    {tabs.map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all duration-300 ${
                                                activeTab === tab.id 
                                                    ? 'gradient-button text-white shadow-lg' 
                                                    : 'text-gray-600 hover:text-purple-600 hover:bg-gray-50'
                                            }`}
                                        >
                                            {tab.icon}
                                            <span>{tab.name}</span>
                                        </button>
                                    ))}
                                </nav>

                                {/* Refresh Button */}
                                <div className="flex items-center space-x-4">
                                    <button
                                        onClick={handleRefresh}
                                        disabled={refreshing}
                                        className="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-300 disabled:opacity-50"
                                    >
                                        <div className={refreshing ? 'loading-spinner' : ''}>
                                            <Icons.RefreshCw />
                                        </div>
                                        <span className="hidden sm:inline">Refresh Data</span>
                                    </button>

                                    {/* Mobile Menu Button */}
                                    <button
                                        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                                        className="md:hidden p-2 rounded-lg text-gray-600 hover:bg-gray-100"
                                    >
                                        {mobileMenuOpen ? <Icons.X /> : <Icons.Menu />}
                                    </button>
                                </div>
                            </div>

                            {/* Mobile Navigation */}
                            {mobileMenuOpen && (
                                <div className="md:hidden pb-4">
                                    {tabs.map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => {
                                                setActiveTab(tab.id);
                                                setMobileMenuOpen(false);
                                            }}
                                            className={`flex items-center space-x-2 w-full px-4 py-3 rounded-lg transition-all duration-300 ${
                                                activeTab === tab.id 
                                                    ? 'gradient-button text-white shadow-lg' 
                                                    : 'text-gray-600 hover:text-purple-600 hover:bg-gray-50'
                                            }`}
                                        >
                                            {tab.icon}
                                            <span>{tab.name}</span>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
                        {/* Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4 sm:space-y-8 fade-in">
                                {/* Stats Cards */}
                                <div className="space-y-4 sm:space-y-6">
                                    {/* All 5 cards - 2x2+1 on mobile, single row on larger screens */}
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-2 sm:gap-4 lg:gap-6">
                                        <div className="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 card-hover">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs sm:text-sm font-medium text-gray-600">Total Leads</p>
                                                    <p className="text-xl sm:text-3xl font-bold text-blue-600">{stats.totalLeads}</p>
                                                </div>
                                                <div className="p-2 sm:p-3 bg-blue-100 rounded-lg sm:rounded-xl">
                                                    <Icons.Users />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 card-hover">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs sm:text-sm font-medium text-gray-600">Pending Leads</p>
                                                    <p className="text-xl sm:text-3xl font-bold text-orange-600">{stats.untrackedLeads}</p>
                                                    <p className="text-xs text-gray-500">Not tracked yet</p>
                                                </div>
                                                <div className="p-2 sm:p-3 bg-orange-100 rounded-lg sm:rounded-xl">
                                                    <Icons.AlertCircle />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 card-hover">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs sm:text-sm font-medium text-gray-600">Closed Deals</p>
                                                    <p className="text-xl sm:text-3xl font-bold text-green-600">{stats.closedDeals}</p>
                                                    <p className="text-xs text-gray-500">{stats.conversionRate}% conversion</p>
                                                </div>
                                                <div className="p-2 sm:p-3 bg-green-100 rounded-lg sm:rounded-xl">
                                                    <Icons.CheckCircle />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 card-hover">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs sm:text-sm font-medium text-gray-600">Total Revenue</p>
                                                    <p className="text-xl sm:text-3xl font-bold text-purple-600">{formatCurrency(stats.totalRevenue)}</p>
                                                </div>
                                                <div className="p-2 sm:p-3 bg-purple-100 rounded-lg sm:rounded-xl">
                                                    <Icons.DollarSign />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-6 card-hover col-span-2 md:col-span-1">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs sm:text-sm font-medium text-gray-600">Your Commission</p>
                                                    <p className="text-xl sm:text-3xl font-bold text-pink-600">{formatCurrency(stats.totalCommission)}</p>
                                                    <p className="text-xs text-gray-500">5% of closed deals</p>
                                                </div>
                                                <div className="p-2 sm:p-3 bg-pink-100 rounded-lg sm:rounded-xl">
                                                    <Icons.TrendingUp />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Quick Stats */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2 sm:gap-4 lg:gap-6">
                                    <div className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Deal Pipeline</h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2">
                                                    <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                                    <span className="text-sm text-gray-600">Closed Won</span>
                                                </div>
                                                <span className="font-semibold text-gray-800">{stats.closedDeals}</span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2">
                                                    <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                                    <span className="text-sm text-gray-600">Pending</span>
                                                </div>
                                                <span className="font-semibold text-gray-800">{stats.pendingDeals}</span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2">
                                                    <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                                    <span className="text-sm text-gray-600">Lost</span>
                                                </div>
                                                <span className="font-semibold text-gray-800">{stats.lostDeals}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Upcoming Events</h3>
                                        <div className="text-center">
                                            <p className="text-3xl font-bold text-blue-600">{upcomingEvents.length}</p>
                                            <p className="text-sm text-gray-600">Next 30 days</p>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-4">This Month's Birthdays</h3>
                                        <div className="text-center">
                                            <p className="text-3xl font-bold text-pink-600">{birthdayLeads.length}</p>
                                            <p className="text-sm text-gray-600">Re-booking opportunities</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Recent Activity */}
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-6">Recent Activity</h3>
                                    {(() => {
                                        // Combine leads and deals into one activity feed
                                        const activities = [];
                                        
                                        // Add leads with timestamps
                                        if (Array.isArray(leads)) {
                                            leads.filter(lead => lead && lead.timestamp).forEach(lead => {
                                                activities.push({
                                                    type: 'lead',
                                                    timestamp: lead.timestamp,
                                                    data: lead,
                                                    sortKey: lead.timestamp
                                                });
                                            });
                                        }
                                        
                                        // Add closed deals with timestamps (latest status only)
                                        if (Array.isArray(deals)) {
                                            // Get latest deals only (most recent status for each reference number)
                                            const latestDeals = deals.reduce((acc, deal) => {
                                                if (!deal || !deal.refNumber || !deal.timestamp) return acc;
                                                
                                                const existing = acc[deal.refNumber];
                                                if (!existing) {
                                                    acc[deal.refNumber] = deal;
                                                } else {
                                                    // Compare timestamps to keep the most recent
                                                    try {
                                                        const existingTime = new Date(existing.timestamp);
                                                        const currentTime = new Date(deal.timestamp);
                                                        if (currentTime > existingTime) {
                                                            acc[deal.refNumber] = deal;
                                                        }
                                                    } catch (e) {
                                                        // If timestamp comparison fails, keep the first one
                                                    }
                                                }
                                                return acc;
                                            }, {});
                                            
                                            // Only add closed deals to activity feed
                                            Object.values(latestDeals)
                                                .filter(deal => deal.status === 'Closed(Won)')
                                                .forEach(deal => {
                                                    activities.push({
                                                        type: 'deal',
                                                        timestamp: deal.timestamp,
                                                        data: deal,
                                                        sortKey: deal.timestamp
                                                    });
                                                });
                                        }
                                        
                                        // Sort by timestamp (most recent first) and take top 5
                                        const sortedActivities = activities
                                            .sort((a, b) => {
                                                try {
                                                    return new Date(b.sortKey) - new Date(a.sortKey);
                                                } catch (e) {
                                                    return 0;
                                                }
                                            })
                                            .slice(0, 5);
                                        
                                        if (sortedActivities.length === 0) {
                                            return (
                                                <div className="text-center py-8">
                                                    <p className="text-gray-500">No recent activity available</p>
                                                    <p className="text-xs text-gray-400 mt-1">Leads and deals with timestamps will appear here</p>
                                                </div>
                                            );
                                        }
                                        
                                        return sortedActivities.map((activity, index) => {
                                            if (activity.type === 'lead') {
                                                const lead = activity.data;
                                                return (
                                                    <div key={`lead-${lead.refNumber}-${index}`} className="flex items-center space-x-4 py-4 border-b border-gray-100 last:border-b-0">
                                                        <div className="p-2 bg-blue-100 rounded-lg">
                                                            {getEventIcon(lead.eventType)}
                                                        </div>
                                                        <div className="flex-1">
                                                            <p className="font-medium text-gray-800">{lead.clientName || 'Unknown Client'}</p>
                                                            <p className="text-sm text-gray-600">{lead.eventType || 'Unknown Event'} • {lead.eventDate ? formatDate(lead.eventDate) : 'No Date'}</p>
                                                            <p className="text-xs text-gray-500">New Lead: {lead.timestamp ? formatDate(lead.timestamp) : 'Unknown'}</p>
                                                        </div>
                                                        <div className="flex flex-col items-end space-y-1">
                                                            <span className={`px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(lead.status)}`}>
                                                                {lead.status || 'Unknown'}
                                                            </span>
                                                            <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                                                Lead
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            } else {
                                                const deal = activity.data;
                                                return (
                                                    <div key={`deal-${deal.refNumber}-${index}`} className="flex items-center space-x-4 py-4 border-b border-gray-100 last:border-b-0">
                                                        <div className="p-2 bg-green-100 rounded-lg">
                                                            <Icons.CheckCircle />
                                                        </div>
                                                        <div className="flex-1">
                                                            <p className="font-medium text-gray-800">{deal.refNumber}</p>
                                                            <p className="text-sm text-gray-600">Deal Closed • {formatCurrency(deal.bookingAmount)}</p>
                                                            <p className="text-xs text-gray-500">Closed: {deal.timestamp ? formatDate(deal.timestamp) : 'Unknown'}</p>
                                                        </div>
                                                        <div className="flex flex-col items-end space-y-1">
                                                            <span className="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                                                                Closed(Won)
                                                            </span>
                                                            <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                                                Deal
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            }
                                        });
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* Leads Tab */}
                        {activeTab === 'leads' && (
                            <div className="space-y-6 fade-in">
                                {/* Search Bar */}
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <Icons.Search />
                                        </div>
                                        <input
                                            type="text"
                                            placeholder="Search by name, email, or reference number..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                                        />
                                    </div>
                                    {searchTerm && (
                                        <p className="mt-2 text-sm text-gray-600">
                                            Found {filteredLeads.length} result{filteredLeads.length !== 1 ? 's' : ''}
                                        </p>
                                    )}
                                </div>

                                {/* Leads Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredLeads.map(lead => (
                                        <div key={lead.refNumber} className="bg-white rounded-2xl shadow-lg p-6 card-hover relative">
                                            {/* Tracking Status Banner */}
                                            <div className={`absolute top-0 left-0 right-0 px-4 py-2 rounded-t-2xl text-center text-sm font-medium ${
                                                lead.isTracked 
                                                    ? 'bg-green-100 text-green-800 border-b border-green-200' 
                                                    : 'bg-orange-100 text-orange-800 border-b border-orange-200'
                                            }`}>
                                                {lead.isTracked ? '✓ Tracked' : '⚠ Not Tracked Yet'}
                                            </div>
                                            
                                            {/* Content with top margin for banner */}
                                            <div className="mt-8">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h3 className="font-semibold text-gray-800">{lead.clientName}</h3>
                                                        <p className="text-sm text-gray-600">{lead.refNumber}</p>
                                                        {lead.timestamp && (
                                                            <p className="text-xs text-gray-500">Added: {formatDate(lead.timestamp)}</p>
                                                        )}
                                                    </div>
                                                    <span className={`flex items-center space-x-1 px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(lead.status)}`}>
                                                        {getStatusIcon(lead.status)}
                                                        <span>{lead.status}</span>
                                                    </span>
                                                </div>

                                                <div className="space-y-3">
                                                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                        <Icons.Mail />
                                                        <a href={`mailto:${lead.email}`} className="hover:text-green-600 transition-colors">
                                                            {lead.email}
                                                        </a>
                                                    </div>
                                                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                        <Icons.Phone />
                                                        <a href={`tel:${lead.phone}`} className="hover:text-purple-600 transition-colors">
                                                            {lead.phone}
                                                        </a>
                                                    </div>
                                                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                        <Icons.CalendarIcon />
                                                        <span>{formatDate(lead.eventDate)}</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                        {getEventIcon(lead.eventType)}
                                                        <span>{lead.eventType}</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                        <Icons.Users />
                                                        <span>{lead.numberOfGuests} guests</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                        <Icons.Gift />
                                                        <span>{formatDate(lead.dateOfBirth)}</span>
                                                    </div>
                                                </div>

                                                {lead.message && (
                                                    <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                                                        <p className="text-sm text-gray-700">{lead.message}</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {filteredLeads.length === 0 && (
                                    <div className="text-center py-12">
                                        <Icons.Users />
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">No leads found</h3>
                                        <p className="text-gray-600">No leads match your search criteria.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Deals Tab */}
                        {activeTab === 'deals' && (
                            <div className="space-y-6 fade-in">
                                {/* Filter Dropdown */}
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <div className="flex items-center space-x-4">
                                        <Icons.Filter />
                                        <select
                                            value={dealFilter}
                                            onChange={(e) => setDealFilter(e.target.value)}
                                            className="border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-500 focus:border-green-500"
                                        >
                                            <option>All Deals</option>
                                            <option>Closed(Won)</option>
                                            <option>Pending</option>
                                            <option>Lost</option>
                                        </select>
                                        <span className="text-sm text-gray-600">
                                            Showing {filteredDeals.length} deal{filteredDeals.length !== 1 ? 's' : ''}
                                        </span>
                                    </div>
                                </div>

                                {/* Deals Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredDeals.map((deal, index) => (
                                        <div key={`${deal.refNumber}-${index}`} className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="font-semibold text-gray-800">{deal.refNumber}</h3>
                                                    <p className="text-sm text-gray-600">{deal.timestamp}</p>
                                                </div>
                                                <span className={`flex items-center space-x-1 px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(deal.status)}`}>
                                                    {getStatusIcon(deal.status)}
                                                    <span>{deal.status}</span>
                                                </span>
                                            </div>

                                            <div className="grid grid-cols-1 gap-4 mb-4">
                                                <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                                                    <p className="text-sm text-blue-600 font-medium">Booking Amount</p>
                                                    <p className="text-2xl font-bold text-blue-800">{formatCurrency(deal.bookingAmount)}</p>
                                                </div>

                                                <div className="bg-gradient-to-r from-green-50 to-yellow-50 p-4 rounded-lg">
                                                    <p className="text-sm text-green-600 font-medium">Commission (5%)</p>
                                                    <p className="text-xl font-bold text-green-800">{formatCurrency(deal.commission)}</p>
                                                </div>

                                                <div className="bg-gradient-to-r from-pink-50 to-pink-100 p-4 rounded-lg">
                                                    <p className="text-sm text-pink-600 font-medium">Status</p>
                                                    <p className="text-lg font-bold text-pink-800">
                                                        {deal.latestEntry ? 'Latest' : 'Historical'}
                                                    </p>
                                                </div>
                                            </div>

                                            {deal.notes && (
                                                <div className="p-3 bg-gray-50 rounded-lg">
                                                    <p className="text-sm text-gray-700">{deal.notes}</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                {filteredDeals.length === 0 && (
                                    <div className="text-center py-12">
                                        <Icons.DollarSign />
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">No deals found</h3>
                                        <p className="text-gray-600">No deals match your filter criteria.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Birthdays Tab */}
                        {activeTab === 'birthdays' && (
                            <div className="space-y-6 fade-in">
                                {/* Month Selector */}
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <div className="flex items-center space-x-4">
                                        <Icons.CalendarIcon />
                                        <select
                                            value={selectedMonth}
                                            onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                                            className="border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-500 focus:border-green-500"
                                        >
                                            {months.map((month, index) => (
                                                <option key={index} value={index}>{month}</option>
                                            ))}
                                        </select>
                                        <span className="text-sm text-gray-600">
                                            {birthdayLeads.length} birthday{birthdayLeads.length !== 1 ? 's' : ''} in {months[selectedMonth]}
                                        </span>
                                    </div>
                                </div>

                                {/* Header Card */}
                                <div className="bg-gradient-to-r from-green-500 to-yellow-500 rounded-2xl shadow-lg p-8 text-white">
                                    <div className="flex items-center space-x-4">
                                        <div className="p-4 bg-white bg-opacity-20 rounded-2xl">
                                            <Icons.Gift />
                                        </div>
                                        <div>
                                            <h2 className="text-3xl font-bold">{birthdayLeads.length} Birthdays</h2>
                                            <p className="text-green-100">Re-booking opportunities this month</p>
                                            <p className="text-sm text-green-200 mt-2">
                                                Reach out to these clients and offer them a special birthday package!
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Birthday Cards */}
                                {birthdayLeads.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {birthdayLeads.map(lead => {
                                            const birthDate = new Date(lead.dateOfBirth);
                                            const monthName = months[birthDate.getMonth()];
                                            const day = birthDate.getDate();
                                            
                                            return (
                                                <div key={lead.refNumber} className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                                                    <div className="flex items-center space-x-4 mb-4">
                                                        <div className="p-3 bg-gradient-to-r from-green-500 to-yellow-500 rounded-xl text-white">
                                                            <Icons.Gift />
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-bold text-gray-800">{lead.clientName}</h3>
                                                            <p className="text-sm text-gray-600">Birthday on {monthName} {day}</p>
                                                        </div>
                                                    </div>

                                                    <div className="space-y-3">
                                                        <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                            <Icons.Mail />
                                                            <a href={`mailto:${lead.email}`} className="hover:text-green-600 transition-colors">
                                                                {lead.email}
                                                            </a>
                                                        </div>
                                                        <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                            <Icons.Phone />
                                                            <a href={`tel:${lead.phone}`} className="hover:text-purple-600 transition-colors">
                                                                {lead.phone}
                                                            </a>
                                                        </div>
                                                    </div>

                                                    <button className="w-full mt-4 gradient-button text-white py-2 px-4 rounded-lg hover:shadow-lg transition-all duration-300">
                                                        Send Message
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 mx-auto mb-4 text-gray-400">
                                            <Icons.Gift />
                                        </div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">No Birthdays This Month</h3>
                                        <p className="text-gray-600">Select a different month to view birthday reminders</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Events Tab */}
                        {activeTab === 'events' && (
                            <div className="space-y-6 fade-in">
                                {/* Header */}
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-2xl font-bold text-gray-800">Upcoming Events</h2>
                                        <span className="px-4 py-2 bg-gradient-to-r from-green-500 to-yellow-500 text-white rounded-full text-sm font-medium">
                                            Next 30 Days
                                        </span>
                                    </div>
                                    <p className="text-gray-600 mt-2">
                                        {upcomingEvents.length} event{upcomingEvents.length !== 1 ? 's' : ''} scheduled
                                    </p>
                                </div>

                                {/* Events List */}
                                {upcomingEvents.length > 0 ? (
                                    <div className="space-y-4">
                                        {upcomingEvents.map(lead => {
                                            const eventDate = new Date(lead.eventDate);
                                            const day = eventDate.getDate();
                                            const month = eventDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                                            const daysUntil = getDaysUntilEvent(lead.eventDate);
                                            
                                            return (
                                                <div key={lead.refNumber} className="bg-white rounded-2xl shadow-lg p-6 card-hover">
                                                    <div className="flex items-start space-x-6">
                                                        {/* Date Box */}
                                                        <div className="bg-gradient-to-r from-green-500 to-yellow-500 text-white rounded-xl p-4 text-center min-w-[80px]">
                                                            <div className="text-2xl font-bold">{day}</div>
                                                            <div className="text-xs uppercase">{month}</div>
                                                        </div>

                                                        {/* Event Details */}
                                                        <div className="flex-1">
                                                            <div className="flex items-start justify-between mb-4">
                                                                <div>
                                                                    <h3 className="text-lg font-bold text-gray-800">{lead.clientName}</h3>
                                                                    <p className="text-sm text-gray-600">{lead.refNumber}</p>
                                                                </div>
                                                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${daysUntil.color}`}>
                                                                    {daysUntil.text}
                                                                </span>
                                                            </div>

                                                            <div className="flex items-center space-x-2 mb-4">
                                                                <div className="p-2 bg-green-100 rounded-lg text-green-600">
                                                                    {getEventIcon(lead.eventType)}
                                                                </div>
                                                                <span className="font-medium text-gray-800">{lead.eventType}</span>
                                                            </div>

                                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                                                <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                                    <Icons.Users />
                                                                    <span>{lead.numberOfGuests} guests</span>
                                                                </div>
                                                                <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                                    <Icons.Mail />
                                                                    <a href={`mailto:${lead.email}`} className="hover:text-green-600 transition-colors truncate">
                                                                        {lead.email}
                                                                    </a>
                                                                </div>
                                                                <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                                    <Icons.Phone />
                                                                    <a href={`tel:${lead.phone}`} className="hover:text-purple-600 transition-colors">
                                                                        {lead.phone}
                                                                    </a>
                                                                </div>
                                                                <div className="flex items-center space-x-2 text-sm text-gray-600">
                                                                    <Icons.CalendarIcon />
                                                                    <span>{formatDate(lead.eventDate)}</span>
                                                                </div>
                                                            </div>

                                                            {lead.message && (
                                                                <div className="p-3 bg-gray-50 rounded-lg">
                                                                    <p className="text-sm text-gray-700">{lead.message}</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 mx-auto mb-4 text-gray-400">
                                            <Icons.CalendarIcon size={64} />
                                        </div>
                                        <h3 className="text-lg font-semibold text-gray-800 mb-2">No Upcoming Events</h3>
                                        <p className="text-gray-600">No events scheduled for the next 30 days</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="bg-white border-t border-gray-200 mt-16">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <div className="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                                <div className="text-gray-600">
                                    Lucille's Premium Catering CRM System
                                </div>
                                <div className="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                    <div className="text-sm text-gray-600">
                                        Developer: Jethro Bermejo
                                    </div>
                                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                        API_CONFIG.appsScriptUrl.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') || 
                                        API_CONFIG.appsScriptUrl === 'YOUR_APPS_SCRIPT_URL_HERE'
                                            ? 'bg-red-100 text-red-800' 
                                            : 'bg-green-100 text-green-800'
                                    }`}>
                                        {API_CONFIG.appsScriptUrl.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') || 
                                         API_CONFIG.appsScriptUrl === 'YOUR_APPS_SCRIPT_URL_HERE'
                                            ? 'Not Configured' 
                                            : 'Connected to Google Sheets'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </footer>

                    {/* Setup Instructions Modal */}
                    {(API_CONFIG.appsScriptUrl.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') || 
                      API_CONFIG.appsScriptUrl === 'YOUR_APPS_SCRIPT_URL_HERE') && (
                        <div className="fixed bottom-4 right-4 max-w-sm">
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4 shadow-lg">
                                <h4 className="font-semibold text-red-800 mb-2">⚠️ Configuration Required</h4>
                                <ol className="text-sm text-red-700 space-y-1">
                                    <li>1. Set up your Google Sheets with required columns</li>
                                    <li>2. Deploy your Google Apps Script as a web app</li>
                                    <li>3. Replace 'YOUR_APPS_SCRIPT_URL_HERE' with your URL</li>
                                    <li>4. Refresh to load your data</li>
                                </ol>
                                <p className="text-xs text-red-600 mt-2">See DEPLOYMENT.md for detailed instructions</p>
                            </div>
                        </div>
                    )}

                    {/* Floating Action Buttons */}
                    <div className="fixed bottom-6 right-6 flex flex-col space-y-4 z-50">
                        {/* Google Sheets Floating Button */}
                        <a
                            href="https://docs.google.com/spreadsheets/d/18dwG4K7r0Zt4RXSVYvNiE5t8f6-muFImHYhyo1YWdv0/edit?usp=sharing"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="group relative bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110"
                            title="View Google Sheets"
                        >
                            <Icons.FileText size={24} />
                            {/* Tooltip */}
                            <span className="absolute right-full mr-3 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white text-sm px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                View Sheets
                            </span>
                        </a>

                        {/* Google Forms Floating Button */}
                        <a
                            href="https://forms.gle/Ws8tX7kw1qgdbh7A7"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="group relative bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110"
                            title="Add New Lead"
                        >
                            <Icons.Users size={24} />
                            {/* Tooltip */}
                            <span className="absolute right-full mr-3 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white text-sm px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                Add Lead
                            </span>
                        </a>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>
